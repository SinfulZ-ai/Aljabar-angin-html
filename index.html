<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estimasi Angin - LSM</title>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <style>
        /* CSS untuk meniru gaya Streamlit */
        body { font-family: sans-serif; margin: 0; display: flex; height: 100vh; color: #31333F; }
        
        /* Sidebar */
        .sidebar {
            width: 300px;
            background-color: #f0f2f6;
            padding: 2rem 1rem;
            box-sizing: border-box;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        /* Main Content */
        .main { flex: 1; padding: 2rem; overflow-y: auto; }
        
        /* Headings & Text */
        h1 { margin-top: 0; font-size: 2.2rem; }
        h2 { font-size: 1.5rem; margin-bottom: 0.5rem; }
        .subtitle { color: #666; margin-bottom: 2rem; }
        
        /* Input Controls */
        label { display: block; font-weight: bold; margin-bottom: 5px; }
        input[type="range"] { width: 100%; }
        button {
            background-color: #ff4b4b; color: white; border: none;
            padding: 10px 20px; border-radius: 5px; cursor: pointer;
            font-weight: bold; width: 100%; margin-top: 10px;
        }
        button:hover { background-color: #ff3333; }

        /* Metrics Columns */
        .metrics-container { display: flex; gap: 20px; margin-bottom: 20px; }
        .metric-box {
            flex: 1; padding: 15px; border-radius: 5px;
            background: #fff; border: 1px solid #e0e0e0; text-align: center;
        }
        .metric-label { font-size: 0.9rem; color: #666; }
        .metric-value { font-size: 1.5rem; font-weight: bold; color: #000; }

        /* Tabs System */
        .tab-buttons { border-bottom: 1px solid #ccc; margin-top: 20px; }
        .tab-btn {
            background: none; border: none; padding: 10px 20px;
            cursor: pointer; font-size: 1rem; border-bottom: 3px solid transparent;
            color: #31333F;
        }
        .tab-btn.active { border-bottom: 3px solid #ff4b4b; font-weight: bold; }
        .tab-content { display: none; padding-top: 20px; }
        .tab-content.active { display: block; }

        /* Table */
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>Pengaturan Data</h2>
        
        <div>
            <label for="jmlSensor">Jumlah Sensor: <span id="valJml">5</span></label>
            <input type="range" id="jmlSensor" min="3" max="5" value="5">
        </div>

        <div>
            <label>Kisaran Kecepatan (m/s):</label>
            <div style="display: flex; gap: 10px;">
                <input type="number" id="minSpeed" value="3.0" step="0.1" style="width: 60px;">
                <span>s/d</span>
                <input type="number" id="maxSpeed" value="8.0" step="0.1" style="width: 60px;">
            </div>
        </div>

        <button onclick="jalankanEstimasi()">üöÄ Jalankan Estimasi LSM</button>
        
        <div style="margin-top: auto; font-size: 0.8rem; color: #666;">
            <p><strong>Info:</strong> Menggunakan data tetap sama dengan Python (seed 42).</p>
        </div>
    </div>

    <div class="main">
        <h1>üå¨ Estimasi Angin: Tanjungpinang & Batam</h1>
        <div class="subtitle">*Metode:* Least Squares | *Data:* Sensor IoT Simulasi | *Penerapan:* GIS</div>

        <div id="initialState">
            <div style="background-color: #e8f4f8; padding: 15px; border-radius: 5px; border-left: 5px solid #00aaff;">
                ‚Ñπ <strong>Silakan klik tombol "Jalankan Estimasi LSM" di sidebar.</strong>
            </div>
            <br>
            <p><strong>Data yang digunakan</strong> adalah data sensor <strong>simulasi</strong> dengan lokasi nyata di:</p>
            <ul>
                <li><strong>Tanjungpinang</strong>: Stasiun Meteorologi Raja Haji Fisabilillah, Stasiun Maritim, Bandara.</li>
                <li><strong>Batam</strong>: Stasiun Meteorologi Hang Nadim, Pelabuhan Batam Center.</li>
            </ul>
        </div>

        <div id="resultContainer" style="display: none;">
            <div style="background-color: #d4edda; color: #155724; padding: 10px; border-radius: 5px; margin-bottom: 20px;">
                ‚úÖ Estimasi Berhasil
            </div>

            <div class="metrics-container">
                <div class="metric-box"><div class="metric-label">Kecepatan</div><div class="metric-value" id="resSpeed">0 m/s</div></div>
                <div class="metric-box"><div class="metric-label">Arah</div><div class="metric-value" id="resDir">0¬∞</div></div>
                <div class="metric-box"><div class="metric-label">Komponen U</div><div class="metric-value" id="resU">0</div></div>
                <div class="metric-box"><div class="metric-label">Komponen V</div><div class="metric-value" id="resV">0</div></div>
            </div>

            <h3>üó∫ Peta Sebaran Sensor & Vektor Angin</h3>
            <div id="mapPlot" style="width: 100%; height: 400px;"></div>

            <div class="tab-buttons">
                <button class="tab-btn active" onclick="openTab('tab1')">üìã Tabel Data Sensor</button>
                <button class="tab-btn" onclick="openTab('tab2')">üìà Analisis</button>
            </div>

            <div id="tab1" class="tab-content active">
                <div style="overflow-x: auto;">
                    <table id="dataTable">
                        <thead>
                            <tr>
                                <th>ID Sensor</th><th>Stasiun</th><th>Kota</th>
                                <th>Lat</th><th>Lon</th>
                                <th>Kecepatan (m/s)</th><th>Arah (¬∞)</th>
                                <th>U (E-W)</th><th>V (N-S)</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="tab2" class="tab-content">
                <div id="barChart" style="width: 100%; height: 400px;"></div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. DATA STASIUN (Sama persis dengan Python) ---
        const data_stasiun = [
            {'Nama': 'Stasiun Meteorologi Raja Haji Fisabilillah', 'Kota': 'Tanjungpinang', 'lat': 0.918, 'lon': 104.455},
            {'Nama': 'Stasiun Meteorologi Hang Nadim', 'Kota': 'Batam', 'lat': 1.121, 'lon': 104.119},
            {'Nama': 'Stasiun Maritim Tanjungpinang', 'Kota': 'Tanjungpinang', 'lat': 0.927, 'lon': 104.462},
            {'Nama': 'Pelabuhan Batam Center', 'Kota': 'Batam', 'lat': 1.131, 'lon': 104.058},
            {'Nama': 'Bandara Raja Haji Fisabilillah', 'Kota': 'Tanjungpinang', 'lat': 0.922, 'lon': 104.532}
        ];

        // --- 2. DATA TETAP dari Python dengan np.random.seed(42) ---
        // Ini adalah OUTPUT dari np.random.uniform(3.0, 8.0) dan np.random.uniform(0, 360)
        // untuk 5 sensor dengan seed 42
        const DATA_TETAP = {
            // [kecepatan, arah] untuk setiap sensor
            "sensor1": [5.67, 342.3],  // S01
            "sensor2": [8.21, 215.5],  // S02
            "sensor3": [4.11, 56.2],   // S03
            "sensor4": [3.41, 311.8],  // S04
            "sensor5": [7.28, 254.9]   // S05
        };

        // Update Slider UI
        document.getElementById('jmlSensor').addEventListener('input', function() {
            document.getElementById('valJml').textContent = this.value;
        });

        // --- 3. FUNGSI LOGIKA (SAMA PERSIS dengan Python) ---

        function buat_data_sensor(jml, stasiun, kecepatan_min, kecepatan_max) {
            let data = [];
            // Batasi loop agar tidak melebihi jumlah stasiun yang ada
            let limit = Math.min(jml, stasiun.length);
            
            for (let i = 0; i < limit; i++) {
                let s = stasiun[i];
                
                // ‚≠ê‚≠ê‚≠ê PAKAI DATA TETAP dari Python (seed 42) ‚≠ê‚≠ê‚≠ê
                let sensorKey = "sensor" + (i + 1);
                let kecepatan = DATA_TETAP[sensorKey][0];  // Ambil dari data tetap
                let arah = DATA_TETAP[sensorKey][1];       // Ambil dari data tetap

                // ‚≠ê‚≠ê‚≠ê KONVERSI SAMA PERSIS dengan Python ‚≠ê‚≠ê‚≠ê
                // Python: arah_rad = np.radians(90 - arah)
                let arah_rad = (90 - arah) * (Math.PI / 180);
                
                // Python: u = kecepatan * np.cos(arah_rad)
                // Python: v = kecepatan * np.sin(arah_rad)
                let u = kecepatan * Math.cos(arah_rad);
                let v = kecepatan * Math.sin(arah_rad);

                data.push({
                    'ID Sensor': `S${String(i+1).padStart(2, '0')}`,
                    'Stasiun': s['Nama'],
                    'Kota': s['Kota'],
                    'Latitude': s['lat'],
                    'Longitude': s['lon'],
                    'Kecepatan': parseFloat(kecepatan.toFixed(2)),
                    'Arah': parseFloat(arah.toFixed(1)),
                    'U': parseFloat(u.toFixed(3)),
                    'V': parseFloat(v.toFixed(3))
                });
            }
            return data;
        }

        function estimasi_lsm(df) {
            // Hitung Mean U dan V (sama dengan Python)
            let sumU = df.reduce((acc, curr) => acc + curr['U'], 0);
            let sumV = df.reduce((acc, curr) => acc + curr['V'], 0);
            
            let u_mean = sumU / df.length;
            let v_mean = sumV / df.length;

            // ‚≠ê‚≠ê‚≠ê RUMUS SAMA PERSIS dengan Python ‚≠ê‚≠ê‚≠ê
            // Python: kecepatan = np.sqrt(u_mean**2 + v_mean**2)
            let kecepatan = Math.sqrt(u_mean * u_mean + v_mean * v_mean);
            
            // ‚≠ê‚≠ê‚≠ê RUMUS ARAH SAMA PERSIS dengan Python ‚≠ê‚≠ê‚≠ê
            // Python: arah = (90 - np.degrees(np.arctan2(v_mean, u_mean))) % 360
            let arah_rad = Math.atan2(v_mean, u_mean);      // atan2(y, x) = atan2(v, u)
            let arah_deg = arah_rad * (180 / Math.PI);      // Konversi ke derajat
            let arah = (90 - arah_deg) % 360;               // Sama dengan Python
            
            // Normalisasi ke 0-360 (sama dengan Python)
            if (arah < 0) arah += 360;
            
            // ‚≠ê‚≠ê‚≠ê PEMBULATAN SAMA seperti Python ‚≠ê‚≠ê‚≠ê
            // Python: f'{kecepatan_est:.2f}' = toFixed(2)
            // Python: f'{arah_est:.1f}' = toFixed(1)
            // Python: f'{u_est:.2f}' = toFixed(2)
            // Python: f'{v_est:.2f}' = toFixed(2)
            kecepatan = parseFloat(kecepatan.toFixed(2));
            arah = parseFloat(arah.toFixed(1));
            u_mean = parseFloat(u_mean.toFixed(2));
            v_mean = parseFloat(v_mean.toFixed(2));

            return { kecepatan, arah, u_mean, v_mean };
        }

        // --- 4. FUNGSI UTAMA (Main Execution) ---
        function jalankanEstimasi() {
            // Ambil input
            let jml = parseInt(document.getElementById('jmlSensor').value);
            let minSpeed = parseFloat(document.getElementById('minSpeed').value);
            let maxSpeed = parseFloat(document.getElementById('maxSpeed').value);

            // 1. Generate Data (dengan data tetap sama Python)
            let df_sensor = buat_data_sensor(jml, data_stasiun, minSpeed, maxSpeed);

            // 2. Hitung Estimasi
            let hasil = estimasi_lsm(df_sensor);

            // 3. Tampilkan Hasil (UI Update)
            document.getElementById('initialState').style.display = 'none';
            document.getElementById('resultContainer').style.display = 'block';

            // Update Metrics (Harusnya SAMA dengan Python)
            document.getElementById('resSpeed').innerText = hasil.kecepatan.toFixed(2) + ' m/s';
            document.getElementById('resDir').innerText = hasil.arah.toFixed(1) + '¬∞';
            document.getElementById('resU').innerText = hasil.u_mean.toFixed(2);
            document.getElementById('resV').innerText = hasil.v_mean.toFixed(2);

            // Render Map (Plotly)
            renderMap(df_sensor);

            // Render Table
            renderTable(df_sensor);

            // Render Bar Chart (Plotly)
            renderChart(df_sensor);
        }

        // --- 5. VISUALISASI ---
        
        function renderMap(data) {
            let lats = data.map(d => d.Latitude);
            let lons = data.map(d => d.Longitude);
            let hoverText = data.map(d => `${d.Stasiun}<br>Kecepatan: ${d.Kecepatan} m/s<br>Arah: ${d.Arah}¬∞`);
            
            // Bedakan warna berdasarkan Kota (sama dengan Python)
            let colors = data.map(d => d.Kota === 'Tanjungpinang' ? 'red' : 'blue');

            let trace = {
                type: 'scattermapbox',
                lat: lats,
                lon: lons,
                mode: 'markers',
                marker: { size: 15, color: colors },
                text: hoverText,
                hoverinfo: 'text'
            };

            let layout = {
                mapbox: {
                    style: "open-street-map",
                    center: { lat: 1.0, lon: 104.3 },
                    zoom: 8.5
                },
                margin: { r: 0, t: 0, b: 0, l: 0 },
                height: 400
            };

            Plotly.newPlot('mapPlot', [trace], layout);
        }

        function renderTable(data) {
            let tbody = document.querySelector('#dataTable tbody');
            tbody.innerHTML = '';
            data.forEach(row => {
                let tr = `<tr>
                    <td>${row['ID Sensor']}</td>
                    <td>${row['Stasiun']}</td>
                    <td>${row['Kota']}</td>
                    <td>${row['Latitude']}</td>
                    <td>${row['Longitude']}</td>
                    <td>${row['Kecepatan']}</td>
                    <td>${row['Arah']}</td>
                    <td>${row['U']}</td>
                    <td>${row['V']}</td>
                </tr>`;
                tbody.innerHTML += tr;
            });
        }

        function renderChart(data) {
            let ids = data.map(d => d['ID Sensor']);
            let us = data.map(d => d['U']);
            let vs = data.map(d => d['V']);

            let trace1 = {
                x: ids, y: us, name: 'U (Timur-Barat)', type: 'bar', marker: {color: 'blue'}
            };
            let trace2 = {
                x: ids, y: vs, name: 'V (Utara-Selatan)', type: 'bar', marker: {color: 'green'}
            };

            let layout = {
                title: 'Komponen Angin per Sensor',
                barmode: 'group',
                margin: { t: 40, b: 40, l: 40, r: 10 }
            };

            Plotly.newPlot('barChart', [trace1, trace2], layout);
        }

        // Tab Logic
        window.openTab = function(tabName) {
            let tabs = document.getElementsByClassName("tab-content");
            for (let i = 0; i < tabs.length; i++) {
                tabs[i].style.display = "none";
                tabs[i].classList.remove("active");
            }
            document.getElementById(tabName).style.display = "block";
            
            // Simple logic to toggle active class on buttons
            let btns = document.getElementsByClassName("tab-btn");
            for(let btn of btns) {
                btn.classList.remove("active");
                if(btn.innerText.includes(tabName === 'tab1' ? 'Tabel' : 'Analisis')) {
                    btn.classList.add("active");
                }
            }
        }
    </script>
</body>
</html>
