<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Estimasi Angin LSM</title>

<script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>

<style>
body { font-family: sans-serif; margin: 0; display: flex; height: 100vh; }
.sidebar {
    width: 300px; background: #f0f2f6; padding: 20px;
    border-right: 1px solid #ddd;
}
.main { flex: 1; padding: 20px; overflow-y: auto; }
button {
    width: 100%; padding: 10px;
    background: #ff4b4b; color: white;
    border: none; border-radius: 5px;
    font-weight: bold; cursor: pointer;
}
.metric-box {
    border: 1px solid #ddd; padding: 10px;
    border-radius: 5px; text-align: center;
}
.metrics-container { display: flex; gap: 10px; margin-bottom: 20px; }
table { width: 100%; border-collapse: collapse; }
th, td { border: 1px solid #ddd; padding: 6px; font-size: 0.85rem; }
th { background: #f2f2f2; }
</style>
</head>

<body>

<!-- SIDEBAR -->
<div class="sidebar">
    <h3>Pengaturan</h3>

    <label>Jumlah Sensor: <span id="valJml">5</span></label>
    <input type="range" id="jmlSensor" min="3" max="5" value="5">

    <br><br>
    <label>Kecepatan (m/s)</label>
    <input type="number" id="minSpeed" value="3" step="0.1"> s/d
    <input type="number" id="maxSpeed" value="8" step="0.1">

    <br><br>
    <button onclick="jalankanEstimasi()">ðŸš€ Jalankan Estimasi</button>
</div>

<!-- MAIN -->
<div class="main">
<h1>ðŸŒ¬ Estimasi Arah Angin (LSM)</h1>
<p>Tanjungpinang & Batam â€“ Data Sensor Simulasi</p>

<div id="result" style="display:none;">

<div class="metrics-container">
    <div class="metric-box"><b>Kecepatan</b><div id="resSpeed">0</div></div>
    <div class="metric-box"><b>Arah</b><div id="resDir">0</div></div>
    <div class="metric-box"><b>U</b><div id="resU">0</div></div>
    <div class="metric-box"><b>V</b><div id="resV">0</div></div>
</div>

<h3>ðŸ—º Peta Sensor & Vektor Angin</h3>
<div id="mapPlot" style="height:400px;"></div>

<h3>ðŸ“‹ Data Sensor</h3>
<table>
<thead>
<tr>
<th>ID</th><th>Stasiun</th><th>Kota</th>
<th>Lat</th><th>Lon</th>
<th>Speed</th><th>Arah</th><th>U</th><th>V</th>
</tr>
</thead>
<tbody id="dataTable"></tbody>
</table>

</div>
</div>

<script>
/* ================= DATA STASIUN ================= */
const data_stasiun = [
 {Nama:'Stasiun Meteorologi Raja Haji Fisabilillah', Kota:'Tanjungpinang', lat:0.918, lon:104.455},
 {Nama:'Stasiun Meteorologi Hang Nadim', Kota:'Batam', lat:1.121, lon:104.119},
 {Nama:'Stasiun Maritim Tanjungpinang', Kota:'Tanjungpinang', lat:0.927, lon:104.462},
 {Nama:'Pelabuhan Batam Center', Kota:'Batam', lat:1.131, lon:104.058},
 {Nama:'Bandara Raja Haji Fisabilillah', Kota:'Tanjungpinang', lat:0.922, lon:104.532}
];

document.getElementById('jmlSensor').oninput = e =>
    document.getElementById('valJml').innerText = e.target.value;

/* ================= GENERATE DATA ================= */
function buat_data_sensor(jml, minS, maxS) {
 let data = [];
 for (let i = 0; i < jml; i++) {
   let s = data_stasiun[i];
   let spd = Math.random()*(maxS-minS)+minS;
   let dir = Math.random()*360;
   let rad = (90-dir)*Math.PI/180;
   let u = spd*Math.cos(rad);
   let v = spd*Math.sin(rad);

   data.push({
     id:`S${String(i+1).padStart(2,'0')}`,
     ...s,
     spd:+spd.toFixed(2),
     dir:+dir.toFixed(1),
     u:+u.toFixed(3),
     v:+v.toFixed(3)
   });
 }
 return data;
}

/* ================= LSM ================= */
function estimasi_lsm(d) {
 let u = d.reduce((a,b)=>a+b.u,0)/d.length;
 let v = d.reduce((a,b)=>a+b.v,0)/d.length;
 let spd = Math.sqrt(u*u+v*v);
 let dir = (90-Math.atan2(v,u)*180/Math.PI+360)%360;
 return {spd,dir,u,v};
}

/* ================= MAIN ================= */
function jalankanEstimasi(){
 let jml = +jmlSensor.value;
 let minS = +minSpeed.value;
 let maxS = +maxSpeed.value;

 let data = buat_data_sensor(jml,minS,maxS);
 let h = estimasi_lsm(data);

 document.getElementById('result').style.display='block';
 resSpeed.innerText = h.spd.toFixed(2)+' m/s';
 resDir.innerText = h.dir.toFixed(1)+'Â°';
 resU.innerText = h.u.toFixed(2);
 resV.innerText = h.v.toFixed(2);

 renderMap(data);
 renderTable(data);
}

/* ================= MAP ================= */
function renderMap(data){
 let points = {
   type:'scattermapbox',
   lat:data.map(d=>d.lat),
   lon:data.map(d=>d.lon),
   mode:'markers',
   marker:{size:14,color:data.map(d=>d.Kota=='Batam'?'blue':'red')},
   text:data.map(d=>`${d.Nama}<br>${d.spd} m/s`),
 };

 let latA=[], lonA=[];
 data.forEach(d=>{
   latA.push(d.lat, d.lat+d.v*0.05, null);
   lonA.push(d.lon, d.lon+d.u*0.05, null);
 });

 let vector = {
   type:'scattermapbox',
   lat:latA, lon:lonA,
   mode:'lines',
   line:{width:3,color:'green'}
 };

 Plotly.newPlot('mapPlot',[points,vector],{
   mapbox:{style:'open-street-map',center:{lat:1.02,lon:104.3},zoom:8.5},
   margin:{t:0,b:0,l:0,r:0}
 });
}

/* ================= TABLE ================= */
function renderTable(data){
 let t='';
 data.forEach(d=>{
 t+=`<tr>
 <td>${d.id}</td><td>${d.Nama}</td><td>${d.Kota}</td>
 <td>${d.lat}</td><td>${d.lon}</td>
 <td>${d.spd}</td><td>${d.dir}</td>
 <td>${d.u}</td><td>${d.v}</td></tr>`;
 });
 dataTable.innerHTML=t;
}
</script>
</body>
</html>
